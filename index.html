<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>קביעת תור להסרת שיער בלייזר</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            direction: rtl; /* Set direction to right-to-left for Hebrew */
            /* New feminine and inviting background */
            background: linear-gradient(135deg, #fce4ec 0%, #f3e5f5 50%, #e1bee7 100%); /* Soft pink, lavender, light purple */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background-color: #f8f0fc; /* Lighter, more inviting background for the form container */
            padding: 30px;
            border-radius: 15px;
            /* Softer shadow */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            width: 100%;
            max-width: 600px;
            text-align: center;
        }
        .header {
            color: #8a2be2; /* Purple */
            font-size: 2.2em;
            font-weight: 700;
            margin-bottom: 10px;
        }
        .subheader {
            color: #555;
            font-size: 1.1em;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
            text-align: right;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        .form-group input[type="text"],
        .form-group input[type="tel"],
        .form-group input[type="date"],
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0b0d5; /* Softer border color */
            border-radius: 10px; /* More rounded corners */
            font-size: 1em;
            box-sizing: border-box;
            transition: border-color 0.3s, box-shadow 0.3s; /* Added box-shadow transition */
        }
        .form-group input[type="text"]:focus,
        .form-group input[type="tel"]:focus,
        .form-group input[type="date"]:focus,
        .form-group select:focus {
            border-color: #8a2be2;
            box-shadow: 0 0 0 3px rgba(138, 43, 226, 0.2); /* Subtle focus glow */
            outline: none;
        }
        /* Align placeholder text to the right for all input types */
        .form-group input::placeholder { /* Standard */
            text-align: right;
        }
        .form-group input::-webkit-input-placeholder { /* Chrome, Safari, Opera */
            text-align: right;
        }
        .form-group input::-moz-placeholder { /* Firefox 19+ */
            text-align: right;
        }
        .form-group input:-ms-input-placeholder { /* IE 10+ */
            text-align: right;
        }
        .form-group input:-moz-placeholder { /* Firefox 18- */
            text-align: right;
        }

        /* Removed grid-cols-2 from form elements to stack them vertically */
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 15px;
            text-align: right;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1em;
            color: #333;
        }
        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            border-radius: 5px;
            border: 2px solid #ddd;
            appearance: none;
            -webkit-appearance: none;
            cursor: pointer;
            position: relative;
            background-color: #fff;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .checkbox-item input[type="checkbox"]:checked {
            background-color: #8a2be2;
            border-color: #8a2be2;
        }
        .checkbox-item input[type="checkbox"]:checked::before {
            content: '\2713'; /* Checkmark character */
            display: block;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 14px;
            font-weight: bold;
        }
        .submit-button {
            background: linear-gradient(to right, #8a2be2, #ff69b4); /* Purple to Pink gradient */
            color: white;
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            width: 100%;
            margin-top: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); /* Initial subtle shadow */
        }
        .submit-button:hover {
            transform: translateY(-3px); /* More pronounced lift */
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.25); /* Larger, darker shadow on hover */
        }
        .contact-icons {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-top: 40px;
            margin-bottom: 20px;
        }
        .contact-icon {
            background: linear-gradient(to right, #25d366, #128c7e); /* WhatsApp green */
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2em;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease;
        }
        .contact-icon.phone {
            background: linear-gradient(to right, #8a2be2, #ff69b4); /* Purple to Pink gradient */
        }
        .contact-icon:hover {
            transform: scale(1.1); /* Slightly larger scale on hover */
        }
        .address {
            color: #777;
            font-size: 1em;
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .address i {
            color: #8a2be2;
        }
        .message-box {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: right;
            display: none; /* Hidden by default */
        }
        .message-box.show {
            display: block;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #8a2be2;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none; /* Hidden by default */
        }
        .loading-spinner.show {
            display: block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Styles for the confirmation screen */
        .confirmation-screen {
            display: none; /* Hidden by default */
            padding: 30px; /* Increased padding */
            border-radius: 15px;
            background-color: #f3e5f5; /* Light lavender for confirmation */
            color: #6a1b9a; /* Darker purple text */
            margin-top: 20px;
            text-align: center;
            font-size: 1.2em; /* Slightly larger font */
            line-height: 1.8; /* Increased line height for readability */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        .confirmation-screen.show {
            display: block;
        }
        .confirmation-screen strong {
            color: #8a2be2;
            font-weight: 700;
        }
        /* Utility for hiding elements */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">עדן קוסמטיקס</div>
        <div class="subheader">מלאי את הפרטים שלך ונקבע לך תור במהירות</div>

        <form id="appointmentForm">
            <!-- Full Name -->
            <div class="form-group">
                <label for="fullName">הכניסי את השם שלך</label>
                <input type="text" id="fullName" name="fullName" placeholder="הכניסי את השם שלך" required>
            </div>
            <!-- Phone Number -->
            <div class="form-group">
                <label for="phone">מספר טלפון</label>
                <input type="tel" id="phone" name="phone" placeholder="מספר טלפון" required>
            </div>

            <!-- Treatment Areas -->
            <div class="form-group">
                <label>איזה אזורים תרצי לטפל?</label>
                <div class="subheader">בחרי את האזורים שתרצי לטפל בהם (ניתן לבחור כמה)</div>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="face" name="treatmentArea" value="face">
                        <label for="face">פנים</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="chest" name="treatmentArea" value="chest">
                        <label for="chest">חזה</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="stomach" name="treatmentArea" value="stomach">
                        <label for="stomach">בטן</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="armpits" name="treatmentArea" value="armpits">
                        <label for="armpits">מפשעות</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="legs" name="treatmentArea" value="legs">
                        <label for="legs">רגליים</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="back" name="treatmentArea" value="back">
                        <label for="back">גב</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="hands" name="treatmentArea" value="hands">
                        <label for="hands">שחי</label>
                    </div>
                    <!-- Existing New Treatment Areas -->
                    <div class="checkbox-item">
                        <input type="checkbox" id="yadim" name="treatmentArea" value="yadim">
                        <label for="yadim">ידיים</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="yeshban" name="treatmentArea" value="yeshban">
                        <label for="yeshban">ישבן</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="pasYeshban" name="treatmentArea" value="pasYeshban">
                        <label for="pasYeshban">פס ישבן</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="gavTachton" name="treatmentArea" value="gavTachton">
                        <label for="gavTachton">גב תחתון</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="chatziRegel" name="treatmentArea" value="chatziRegel">
                        <label for="chatziRegel">חצי רגל</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="chatziYad" name="treatmentArea" value="chatziYad">
                        <label for="chatziYad">חצי יד</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="pasBaten" name="treatmentArea" value="pasBaten">
                        <label for="pasBaten">פס בטן</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="itzuvGabot" name="treatmentArea" value="itzuvGabot">
                        <label for="itzuvGabot">עיצוב גבות</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="safam" name="treatmentArea" value="safam">
                        <label for="safam">שפם(חוט או שעווה)</label>
                    </div>
                    <!-- New Exclusive Treatment Areas -->
                    <div class="checkbox-item">
                        <input type="checkbox" id="wholeBodyNoFace" name="treatmentArea" value="wholeBodyNoFace">
                        <label for="wholeBodyNoFace">כל הגוף (ללא פנים)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="wholeBodyWithFace" name="treatmentArea" value="wholeBodyWithFace">
                        <label for="wholeBodyWithFace">כל הגוף (כולל פנים)</label>
                    </div>
                </div>
            </div>

            <!-- Appointment Date -->
            <div class="form-group">
                <label for="appointmentDate">בחרי תאריך</label>
                <input type="date" id="appointmentDate" name="appointmentDate" required>
            </div>
            <!-- Appointment Time -->
            <div class="form-group">
                <label for="appointmentTime">בחרי שעה</label>
                <select id="appointmentTime" name="appointmentTime" disabled required>
                    <option value="">בחר תאריך תחילה</option>
                </select>
            </div>

            <button type="submit" class="submit-button">קביעת תור</button>
        </form>

        <div id="confirmationScreen" class="confirmation-screen">
            <!-- Confirmation message will be inserted here -->
        </div>

        <div id="messageBox" class="message-box"></div>
        <div id="loadingSpinner" class="loading-spinner"></div>

        <div class="contact-icons">
            <a href="https://wa.me/972525570909" target="_blank" class="contact-icon whatsapp">
                <i class="fab fa-whatsapp"></i>
            </a>
            <a href="tel:+972525570909" class="contact-icon phone">
                <i class="fas fa-phone"></i>
            </a>
        </div>
        <div class="address">
            <i class="fas fa-map-marker-alt"></i>
            הפלדה 3, אור יהודה
        </div>
    </div>

    <script>
        // Define the N8N webhook URL for fetching existing appointments
        // Changed to webhook for production environment
        const N8N_FETCH_WEBHOOK_URL = 'https://balikal.app.n8n.cloud/webhook/ba968965-676e-4feb-a7ed-ae77665cf803';
        // Define the N8N webhook URL for submitting new appointments
        // Changed to webhook for production environment
        const N8N_SUBMIT_WEBHOOK_URL = 'https://balikal.app.n8n.cloud/webhook/ba968965-676e-4feb-a7ed-ae77665cf803';

        // Treatment area durations in minutes
        const TREATMENT_DURATIONS = {
            face: 10,
            chest: 5,
            stomach: 5,
            armpits: 5,
            legs: 10,
            back: 5,
            hands: 10,
            yadim: 10, // ידיים
            yeshban: 5, // ישבן
            pasYeshban: 5, // פס ישבן
            gavTachton: 5, // גב תחתון
            chatziRegel: 5, // חצי רגל
            chatziYad: 5, // חצי יד
            pasBaten: 5, // פס בטן
            itzuvGabot: 30, // עיצוב גבות
            safam: 10, // שפם(חוט או שעווה)
            wholeBodyNoFace: 120, // 2 hours for whole body without face
            wholeBodyWithFace: 150 // 2.5 hours for whole body with face
        };

        // Mapping English treatment area values to Hebrew display names
        const TREATMENT_AREA_HEBREW_NAMES = {
            face: 'פנים',
            chest: 'חזה',
            stomach: 'בטן',
            armpits: 'מפשעות',
            legs: 'רגליים',
            back: 'גב',
            hands: 'שחי',
            yadim: 'ידיים',
            yeshban: 'ישבן',
            pasYeshban: 'פס ישבן',
            gavTachton: 'גב תחתון',
            chatziRegel: 'חצי רגל',
            chatziYad: 'חצי יד',
            pasBaten: 'פס בטן',
            itzuvGabot: 'עיצוב גבות',
            safam: 'שפם (חוט או שעווה)',
            wholeBodyNoFace: 'כל הגוף (ללא פנים)',
            wholeBodyWithFace: 'כל הגוף (כולל פנים)'
        };


        // Business working hours
        const WORKING_HOURS = {
            sunday: { start: '10:00', end: '20:00' },
            monday: { start: '10:00', end: '20:00' },
            tuesday: { start: '10:00', end: '20:00' },
            wednesday: { start: '10:00', end: '20:00' },
            thursday: { start: '10:00', end: '20:00' },
            friday: { start: '09:00', end: '13:00' },
            saturday: null // Closed on Saturday
        };

        let existingAppointments = []; // Stores appointments fetched from N8N

        const appointmentDateInput = document.getElementById('appointmentDate');
        const appointmentTimeSelect = document.getElementById('appointmentTime');
        const appointmentForm = document.getElementById('appointmentForm');
        const messageBox = document.getElementById('messageBox');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const confirmationScreen = document.getElementById('confirmationScreen'); // Get the new confirmation screen element

        /**
         * Displays a message in the message box.
         * @param {string} message - The message to display (can be HTML).
         * @param {string} type - The type of message (e.g., 'success', 'error').
         * @param {number} [duration=5000] - How long the message should be visible in milliseconds.
         */
        function showMessage(message, type = 'info', duration = 5000) {
            messageBox.innerHTML = message; // Changed from textContent to innerHTML
            messageBox.className = 'message-box show';
            if (type === 'error') {
                messageBox.style.backgroundColor = '#f8d7da';
                messageBox.style.color = '#721c24';
                messageBox.style.borderColor = '#f5c6cb';
            } else if (type === 'success') {
                messageBox.style.backgroundColor = '#d4edda';
                messageBox.style.color = '#155724';
                messageBox.style.borderColor = '#c3e6cb';
            } else {
                messageBox.style.backgroundColor = '#e2e3e5';
                messageBox.style.color = '#383d41';
                messageBox.style.borderColor = '#d6d8db';
            }
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, duration); // Use the provided duration
        }

        /**
         * Shows or hides the loading spinner.
         * @param {boolean} show - True to show, false to hide.
         */
        function toggleLoadingSpinner(show) {
            if (show) {
                loadingSpinner.classList.add('show');
            } else {
                loadingSpinner.classList.remove('show');
            }
        }

        /**
         * Fetches existing appointments from N8N when the form loads.
         * Sends a "הטופס נטען" message to N8N.
         */
        async function fetchExistingAppointmentsOnLoad() {
            toggleLoadingSpinner(true);
            let rawResponseText = ''; // Variable to store raw response text
            try {
                const response = await fetch(N8N_FETCH_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    mode: 'cors', // Explicitly set CORS mode
                    body: JSON.stringify({ message: 'הטופס נטען' }),
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('HTTP error response text (fetch):', errorText); // Added (fetch) for clarity
                    showMessage(`שגיאה בטעינת תורים קיימים: ${errorText}`, 'error'); // Show error to user
                    return; // Exit if response not OK
                }

                // Read response as text first to catch JSON parsing errors
                rawResponseText = await response.text();
                console.log('Raw data received from N8N (fetch):', rawResponseText); // Added (fetch) for clarity

                let data;
                try {
                    data = JSON.parse(rawResponseText);
                } catch (jsonError) {
                    console.error('Failed to parse JSON from N8N response (fetch):', jsonError); // Added (fetch)
                    // Do NOT throw here, just show message and continue
                    showMessage(`שגיאה בניתוח נתוני תורים קיימים מ-N8N: ${jsonError.message}. אנא ודא שה-N8N שלך מחזיר JSON תקין.`, 'error');
                    existingAppointments = []; // Reset to empty array to prevent further errors
                    return; // Exit if JSON is invalid
                }


                // Check if data is an array
                if (Array.isArray(data)) {
                    // If data is an array, transform each item
                    existingAppointments = data.map(app => {
                        // Check if app, start, end objects and their dateTime properties exist
                        if (app && app.start && app.start.dateTime && app.end && app.end.dateTime) {
                            return {
                                start: app.start.dateTime,
                                end: app.end.dateTime
                            };
                        } else {
                            console.warn('Skipping appointment in array due to missing or invalid start/end dateTime in N8N response:', app);
                            return null; // Return null for invalid appointments
                        }
                    }).filter(app => app !== null); // Filter out any null entries
                    console.log('Transformed existing appointments (after fetch):', existingAppointments); // Added log
                    showMessage('התורים הקיימים נטענו בהצלחה.', 'success');

                } else if (data && typeof data === 'object' && data.start && data.end && data.start.dateTime && data.end.dateTime) {
                    // This case: N8N returns a single full event object (not in an array)
                    console.warn('N8N returned a single full event object instead of an array. Wrapping it in an array.');
                    existingAppointments = [{
                        start: data.start.dateTime,
                        end: data.end.dateTime
                    }];
                    console.log('Transformed existing appointments (after fetch, single object):', existingAppointments); // Added log
                    showMessage('התורים הקיימים נטענו בהצלחה (אובייקט תור בודד זוהה).', 'success');
                }
                else {
                    // General case for unexpected non-array response
                    console.error('N8N response is not an array. Expected an array of appointments (each with start.dateTime and end.dateTime). Received:', data);
                    existingAppointments = []; // Reset to empty array to prevent filter error
                    showMessage('שגיאה: N8N החזיר נתונים בפורמט שגוי. אנא ודא שה-Webhook ב-N8N מחזיר *מערך* של אובייקטי תורים מלאים, כאשר כל אובייקט מכיל שדות "start" ו-"end" עם "dateTime" מקונן.', 'error');
                }
            } catch (error) {
                console.error('שגיאה כללית בטעינת תורים קיימים מ-N8N:', error); // Changed message for clarity
                const errorMessage = `שגיאה בטעינת תורים קיימים. ייתכן שקיימת בעיית רשת. אנא ודא שה-N8N שלך פועל ומחזיר JSON תקין. ${error.message}`;
                showMessage(errorMessage, 'error');
            } finally {
                toggleLoadingSpinner(false);
            }
        }

        /**
         * Calculates the total duration required for selected treatment areas.
         * @returns {number} Total duration in minutes.
         */
        function calculateTotalTreatmentDuration() {
            let totalDuration = 0;
            document.querySelectorAll('input[name="treatmentArea"]:checked').forEach(checkbox => {
                totalDuration += TREATMENT_DURATIONS[checkbox.value] || 0;
            });
            console.log('Total duration for selected areas:', totalDuration, 'minutes');
            return totalDuration;
        }

        /**
         * Generates available time slots for a given date, considering working hours and existing appointments.
         * This function now focuses on finding slots immediately adjacent to the earliest start and latest end
         * of all appointments on the selected day.
         * @param {Date} selectedDate - The date for which to generate slots.
         * @param {number} requiredDuration - The duration of the new appointment in minutes.
         * @returns {Array<string>} An array of available time strings (e.g., "10:00", "10:30").
         */
        function getAvailableTimeSlots(selectedDate, requiredDuration) {
            console.log('getAvailableTimeSlots called. existingAppointments:', existingAppointments, 'Type:', typeof existingAppointments, 'Is Array:', Array.isArray(existingAppointments)); // Added log

            const candidateSlots = new Set(); // Use a Set to automatically handle duplicates
            const dayOfWeek = selectedDate.getDay(); // 0 for Sunday, 1 for Monday, etc.
            const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const currentDayWorkingHours = WORKING_HOURS[dayNames[dayOfWeek]];

            if (!currentDayWorkingHours) {
                console.log(`Business is closed on ${dayNames[dayOfWeek]}. No slots available.`);
                return []; // Business is closed on this day
            }

            const workStart = parseTime(currentDayWorkingHours.start);
            const workEnd = parseTime(currentDayWorkingHours.end);

            const workStartDateTime = new Date(selectedDate);
            workStartDateTime.setHours(workStart.hours, workStart.minutes, 0, 0);

            const workEndDateTime = new Date(selectedDate);
            workEndDateTime.setHours(workEnd.hours, workEnd.minutes, 0, 0);

            // Filter and map existing appointments to Date objects for the selected date
            const appointmentsOnSelectedDate = existingAppointments.filter(app => {
                if (!app.start || isNaN(new Date(app.start).getTime())) {
                    console.warn('Invalid appointment start date received:', app.start);
                    return false;
                }
                const appStartDate = new Date(app.start);
                return appStartDate.toDateString() === selectedDate.toDateString();
            }).map(app => ({
                start: new Date(app.start),
                end: new Date(app.end)
            }));

            // Sort existing appointments by start time to easily find the earliest and latest
            appointmentsOnSelectedDate.sort((a, b) => a.start.getTime() - b.start.getTime());
            console.log('Existing appointments on selected date (after parsing):', appointmentsOnSelectedDate);

            // If there are existing appointments, calculate slots adjacent to the consolidated block
            if (appointmentsOnSelectedDate.length > 0) {
                const earliestAppStart = appointmentsOnSelectedDate[0].start; // Start of the first appointment
                const latestAppEnd = appointmentsOnSelectedDate[appointmentsOnSelectedDate.length - 1].end; // End of the last appointment

                // Candidate 1: Slot immediately before the earliest existing appointment
                let candidateEndBefore = new Date(earliestAppStart);
                let candidateStartBefore = new Date(candidateEndBefore.getTime() - requiredDuration * 60 * 1000);

                // Check if this potential slot is within working hours and ends exactly at the earliest appointment's start
                if (candidateStartBefore.getTime() >= workStartDateTime.getTime() &&
                    candidateEndBefore.getTime() === earliestAppStart.getTime()) {
                    candidateSlots.add(formatTime(candidateStartBefore));
                }

                // Candidate 2: Slot immediately after the latest existing appointment
                let candidateStartAfter = new Date(latestAppEnd);
                let candidateEndAfter = new Date(candidateStartAfter.getTime() + requiredDuration * 60 * 1000);

                // Check if this potential slot is within working hours and starts exactly at the latest appointment's end
                if (candidateEndAfter.getTime() <= workEndDateTime.getTime() &&
                    candidateStartAfter.getTime() === latestAppEnd.getTime()) {
                    candidateSlots.add(formatTime(candidateStartAfter));
                }

            } else {
                // Case: No existing appointments on this day, show all possible slots
                let currentTime = new Date(workStartDateTime);
                while (currentTime.getTime() + requiredDuration * 60 * 1000 <= workEndDateTime.getTime()) {
                    candidateSlots.add(formatTime(currentTime));
                    currentTime.setMinutes(currentTime.getMinutes() + 30); // Increment by 30 minutes
                }
            }

            const finalAvailableSlots = Array.from(candidateSlots).sort();

            console.log('Calculated available slots (adjacent to earliest/latest or full day):', finalAvailableSlots);
            if (finalAvailableSlots.length === 0) {
                console.log('No available slots found for the selected date and duration.');
            }
            return finalAvailableSlots;
        }

        /**
         * Parses a time string (e.g., "10:00") into hours and minutes.
         * @param {string} timeString - The time string.
         * @returns {{hours: number, minutes: number}}
         */
        function parseTime(timeString) {
            const [hours, minutes] = timeString.split(':').map(Number);
            return { hours, minutes };
        }

        /**
         * Formats a Date object into a "HH:MM" time string.
         * @param {Date} date - The Date object.
         * @returns {string} Formatted time string.
         */
        function formatTime(date) {
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        /**
         * Handles the exclusive selection logic for "wholeBody" treatment areas.
         * Disables/enables other checkboxes based on selection.
         */
        function handleExclusiveTreatmentAreas() {
            const allCheckboxes = document.querySelectorAll('input[name="treatmentArea"]');
            const wholeBodyNoFaceCheckbox = document.getElementById('wholeBodyNoFace');
            const wholeBodyWithFaceCheckbox = document.getElementById('wholeBodyWithFace');

            const isWholeBodyNoFaceChecked = wholeBodyNoFaceCheckbox.checked;
            const isWholeBodyWithFaceChecked = wholeBodyWithFaceCheckbox.checked;

            if (isWholeBodyNoFaceChecked || isWholeBodyWithFaceChecked) {
                allCheckboxes.forEach(cb => {
                    if (cb !== wholeBodyNoFaceCheckbox && cb !== wholeBodyWithFaceCheckbox) {
                        cb.checked = false; // Uncheck other boxes
                        cb.disabled = true;  // Disable other boxes
                    }
                });
                // Ensure only one of the exclusive is checked
                if (isWholeBodyNoFaceChecked && wholeBodyWithFaceCheckbox.checked) {
                    wholeBodyWithFaceCheckbox.checked = false;
                }
                if (isWholeBodyWithFaceChecked && wholeBodyNoFaceCheckbox.checked) {
                    wholeBodyNoFaceCheckbox.checked = false;
                }
            } else {
                // If neither exclusive is checked, enable all other checkboxes
                allCheckboxes.forEach(cb => {
                    cb.disabled = false;
                });
            }
            updateTimeSlots(); // Recalculate slots after changing checkbox states
        }


        /**
         * Updates the available time slots dropdown based on selected date and treatment duration.
         */
        function updateTimeSlots() {
            console.log('existingAppointments at start of updateTimeSlots:', existingAppointments); // Added log
            const selectedDateString = appointmentDateInput.value;
            const totalDuration = calculateTotalTreatmentDuration();

            appointmentTimeSelect.innerHTML = '<option value="">בחר שעה</option>'; // Reset options
            appointmentTimeSelect.disabled = true; // Disable until a date is chosen

            if (selectedDateString && totalDuration > 0) {
                const selectedDate = new Date(selectedDateString + 'T00:00:00'); // Use T00:00:00 to avoid timezone issues
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Normalize today's date

                // Disable past dates
                if (selectedDate < today) {
                    showMessage('לא ניתן לבחור תאריך בעבר.', 'error');
                    return;
                }

                const availableSlots = getAvailableTimeSlots(selectedDate, totalDuration);
                console.log('Available slots after calculation:', availableSlots.length);


                if (availableSlots.length > 0) {
                    appointmentTimeSelect.disabled = false;
                    availableSlots.forEach(slot => {
                        const option = document.createElement('option');
                        option.value = slot;
                        option.textContent = slot;
                        appointmentTimeSelect.appendChild(option);
                    });
                } else {
                    showMessage('אין תורים פנויים בתאריך ובמשך הטיפול שבחרת. אנא נסה תאריך או משך טיפול אחר.', 'info');
                }
            } else if (selectedDateString && totalDuration === 0) {
                showMessage('אנא בחר אזורי טיפול כדי לראות שעות פנויות.', 'info');
            }
        }

        // Event listener for date input change
        appointmentDateInput.addEventListener('change', updateTimeSlots);

        // Event listener for all checkbox changes to trigger exclusive logic and time slot update
        document.querySelectorAll('input[name="treatmentArea"]').forEach(checkbox => {
            checkbox.addEventListener('change', handleExclusiveTreatmentAreas); // Call exclusive handler
        });


        // Event listener for form submission
        appointmentForm.addEventListener('submit', async (event) => {
            event.preventDefault(); // Prevent default form submission

            const fullName = document.getElementById('fullName').value;
            const phone = document.getElementById('phone').value;
            const appointmentDate = document.getElementById('appointmentDate').value;
            const appointmentTime = document.getElementById('appointmentTime').value;
            const selectedAreas = Array.from(document.querySelectorAll('input[name="treatmentArea"]:checked'))
                                       .map(cb => cb.value);

            if (!fullName || !phone || !appointmentDate || !appointmentTime || selectedAreas.length === 0) {
                showMessage('אנא מלא את כל השדות ובחר אזורי טיפול.', 'error');
                return;
            }

            const totalDuration = calculateTotalTreatmentDuration();
            if (totalDuration === 0) {
                showMessage('אנא בחר אזורי טיפול.', 'error');
                return;
            }

            const startDateTime = new Date(`${appointmentDate}T${appointmentTime}:00`);
            const endDateTime = new Date(startDateTime.getTime() + totalDuration * 60 * 1000);

            // Map selectedAreas to Hebrew names for the new field
            const selectedAreasHebrew = selectedAreas.map(area => TREATMENT_AREA_HEBREW_NAMES[area] || area);

            // Construct the appointment data in the exact desired format for N8N
            const appointmentData = {
                summary: `${fullName}\n${phone}`, // Name and phone in summary
                start: {
                    dateTime: startDateTime.toISOString(),
                    timeZone: "Asia/Jerusalem" // Fixed timezone
                },
                end: {
                    dateTime: endDateTime.toISOString(),
                    timeZone: "Asia/Jerusalem" // Fixed timezone
                },
                creator: {
                    email: "balikal.saas@gmail.com" // Fixed creator email
                },
                organizer: {
                    email: "17ef1b66bfd3fe63181a3864829162400de1902d65b6328a330074b647ecbbb7@group.calendar.google.com", // Fixed organizer email
                    displayName: "יומן תורים",
                    self: true
                },
                description: selectedAreas.join(', '), // English values for description (as before)
                descriptionHebrew: selectedAreasHebrew.join(', '), // NEW: Hebrew values for description
                eventType: "default", // Fixed eventType
                reminders: {
                    useDefault: true // Fixed reminders
                },
                status: "confirmed" // Fixed status
                // id, created, updated, etag, htmlLink, iCalUID, kind, sequence are typically generated by Google Calendar/N8N
            };

            toggleLoadingSpinner(true);
            try {
                const response = await fetch(N8N_SUBMIT_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    mode: 'cors', // Explicitly set CORS mode
                    body: JSON.stringify(appointmentData),
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('HTTP error response text (submit):', errorText);
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                }

                // Read response as text first to catch JSON parsing errors
                let rawResponseTextSubmit = await response.text(); // Use a different variable name
                console.log('Raw data received from N8N (submit):', rawResponseTextSubmit); // Log raw data for debugging

                let data;
                try {
                    data = JSON.parse(rawResponseTextSubmit);
                } catch (jsonError) {
                    console.error('Failed to parse JSON from N8N response (submit):', jsonError);
                    // If response was OK, but JSON parsing failed, assume success with a warning about response details.
                    if (response.ok) {
                        // Construct message without detailed N8N data, using form data instead
                        const clientName = fullName;
                        const clientPhone = phone;
                        const apptDate = new Date(`${appointmentDate}T${appointmentTime}:00`).toLocaleDateString('he-IL');
                        const apptStartTime = appointmentTime;
                        const apptEndTime = formatTime(endDateTime);
                        // Use the already prepared Hebrew names for display
                        const apptDescriptionHebrew = selectedAreasHebrew.join(', ');


                        const successHtml = `
                            <div class="text-green-700 text-xl font-semibold mb-4">התור נקבע בהצלחה!</div>
                            <div class="text-gray-700 text-lg mb-6">
                                פרטי התור שלך:
                                <br>
                                <strong>שם:</strong> ${clientName}
                                <br>
                                <strong>טלפון:</strong> ${clientPhone}
                                <br>
                                <strong>תאריך:</strong> ${apptDate}
                                <br>
                                <strong>שעה:</strong> ${apptStartTime} - ${apptEndTime}
                                <br>
                                <strong>אזורי טיפול:</strong> ${apptDescriptionHebrew}
                            </div>
                            <button id="bookAnotherBtn" class="submit-button mt-4">קבעי תור נוסף</button>
                        `;
                        confirmationScreen.innerHTML = successHtml;
                        appointmentForm.classList.add('hidden');
                        confirmationScreen.classList.add('show');
                        document.getElementById('bookAnotherBtn').addEventListener('click', () => {
                            confirmationScreen.classList.remove('show');
                            appointmentForm.classList.remove('hidden');
                            appointmentForm.reset();
                            appointmentTimeSelect.innerHTML = '<option value="">בחר תאריך תחילה</option>';
                            appointmentTimeSelect.disabled = true;
                            fetchExistingAppointmentsOnLoad(); // Re-fetch when returning to form
                        });
                        toggleLoadingSpinner(false);
                        return; // Exit here as we've handled the "success with warning"
                    } else {
                        // If response was NOT OK and JSON parsing failed, it's a definite error.
                        showMessage(`שגיאה בניתוח תגובת N8N לאחר קביעת תור: ${jsonError.message}. תגובה גולמית: ${rawResponseTextSubmit}`, 'error');
                        toggleLoadingSpinner(false);
                        return; // Exit here
                    }
                }

                // Main success logic (if N8N returned valid JSON)
                let successHtml = '';
                if (Array.isArray(data) && data.length > 0) {
                    const bookedAppointment = data[0]; // Assuming N8N returns an array with the booked event
                    const clientName = bookedAppointment.summary ? bookedAppointment.summary.split('\n')[0] : fullName; // Fallback to form data
                    const clientPhone = bookedAppointment.summary ? bookedAppointment.summary.split('\n')[1] : phone; // Fallback to form data
                    const apptDate = bookedAppointment.start && bookedAppointment.start.dateTime ? new Date(bookedAppointment.start.dateTime).toLocaleDateString('he-IL') : 'לא ידוע';
                    const apptStartTime = bookedAppointment.start && bookedAppointment.start.dateTime ? formatTime(new Date(bookedAppointment.start.dateTime)) : 'לא ידוע';
                    const apptEndTime = bookedAppointment.end && bookedAppointment.end.dateTime ? formatTime(new Date(bookedAppointment.end.dateTime)) : 'לא ידוע';
                    // Use the already prepared Hebrew names for display
                    const apptDescriptionHebrew = selectedAreasHebrew.join(', ');


                    successHtml = `
                        <div class="text-green-700 text-xl font-semibold mb-4">התור נקבע בהצלחה!</div>
                        <div class="text-gray-700 text-lg mb-6">
                            פרטי התור שלך:
                            <br>
                            <strong>שם:</strong> ${clientName}
                            <br>
                            <strong>טלפון:</strong> ${clientPhone}
                            <br>
                            <strong>תאריך:</strong> ${apptDate}
                            <br>
                            <strong>שעה:</strong> ${apptStartTime} - ${apptEndTime}
                            <br>
                            <strong>אזורי טיפול:</strong> ${apptDescriptionHebrew}
                        </div>
                        <button id="bookAnotherBtn" class="submit-button mt-4">קבעי תור נוסף</button>
                    `;
                } else {
                    console.warn('N8N did not return a valid booked appointment object after submission:', data);
                    // Fallback message if N8N response is valid JSON but not in expected array format
                    const clientName = fullName;
                    const clientPhone = phone;
                    const apptDate = new Date(`${appointmentDate}T${appointmentTime}:00`).toLocaleDateString('he-IL');
                    const apptStartTime = appointmentTime;
                    const apptEndTime = formatTime(endDateTime);
                    // Use the already prepared Hebrew names for display
                    const apptDescriptionHebrew = selectedAreasHebrew.join(', ');


                    successHtml = `
                        <div class="text-green-700 text-xl font-semibold mb-4">התור נקבע בהצלחה!</div>
                        <div class="text-gray-700 text-lg mb-6">
                            פרטי התור שלך:
                            <br>
                            <strong>שם:</strong> ${clientName}
                            <br>
                            <strong>טלפון:</strong> ${clientPhone}
                            <br>
                            <strong>תאריך:</strong> ${apptDate}
                            <br>
                            <strong>שעה:</strong> ${apptStartTime} - ${apptEndTime}
                            <br>
                            <strong>אזורי טיפול:</strong> ${apptDescriptionHebrew}
                        </div>
                        <button id="bookAnotherBtn" class="submit-button mt-4">קבעי תור נוסף</button>
                    `;
                }

                confirmationScreen.innerHTML = successHtml;
                appointmentForm.classList.add('hidden');
                confirmationScreen.classList.add('show');
                document.getElementById('bookAnotherBtn').addEventListener('click', () => {
                    confirmationScreen.classList.remove('show');
                    appointmentForm.classList.remove('hidden');
                    appointmentForm.reset();
                    appointmentTimeSelect.innerHTML = '<option value="">בחר תאריך תחילה</option>';
                    appointmentTimeSelect.disabled = true;
                    fetchExistingAppointmentsOnLoad(); // Re-fetch when returning to form
                });

            } catch (error) {
                console.error('שגיאה בשליחת התור ל-N8N:', error);
                // More specific error message for the user
                showMessage('שגיאה בקביעת התור. ייתכן שקיימת בעיית רשת או הגדרות CORS ב-N8N. אנא ודא שה-N8N שלך מאפשר בקשות מהדומיין הזה, ושהוא מחזיר JSON תקין.', 'error');
            } finally {
                toggleLoadingSpinner(false);
            }
        });

        // Initialize by fetching existing appointments when the page loads
        document.addEventListener('DOMContentLoaded', fetchExistingAppointmentsOnLoad);
    </script>
</body>
</html>
